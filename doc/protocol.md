# Протокол общения с устройством

## Общее описание

Протокол основывается на modbus c усиченной адресацией и проверкой CRC.

| Старший 0 бит | Команда       | Данные     |
| ------------- | ------------- | ---------- |
| 0             | 7 бит команды | до 19 байт |

В зависимости от команды меняется формат данных (аргументов)

В Сумме комманда не должна привышать 20 байт

Номер команды может быть от 0 до 0x7f. Верхний бит команды указывает что ответ это ошибка на команду.

Пример:

Команда 0x10 - Ответ без ошибки 0x10 - Ответ с ошибкой 0x90

Формат ошибки:


| Старший 0 бит | Команда       | Номер ошибки |
| ------------- | ------------- | ------------ |
| 1             | 7 бит команды | 1 байт       |

## Команды

Команды чтения регистров повторяют формат команд в modbus

| Номер | Название | Формат запроса                                               | Формат ответа                                                | Описание                                                 |
| ----- | -------- | ------------------------------------------------------------ | ------------------------------------------------------------ | -------------------------------------------------------- |
| 0x03  | INT_RD   | [ uint16_t,uint16_t ] - [Номер переменной, Количество]       | [uint8_t, uint16_t[0..9]]                                    | Чтение переменной <https://www.simplymodbus.ca/FC03.htm> |
| 0x06  | INT_WR   | [ uint16_t, uint16_t ] - [ Номер переменной, Значение ]      | [ uint16_t, uint16_t ] - [ Номер переменной, Значение ]      | Запись переменной <https://www.simplymodbus.ca/FC06.htm> |
| 0x12  | BLOB_RD  | int24_t - 3 байта адреса                                     | [ int24_t, uint8_t[16] ] - [3 байта адреса, 16 байт данных ] | Чтение памяти (файла)                                    |
| 0x13  | BLOB_WR  | [ int24_t, uint8_t[16] ] - [3 байта адреса, 16 байт данных ] | ACK                                                          | Запись памяти (файла)                                    |

Детальнее src/cmd_hnd.c

## Номера ошибок (исключения)

<https://www.simplymodbus.ca/exceptions.htm>

Используются три типа исключений:

| Номер | Название      | Описание                              |
| ----- | ------------- | ------------------------------------- |
| 1     | CMD_NOT_FOUND | Функция не поддерживается устройством |
| 2     | CMD_ADDR_ERR  | Неправильный адрес                    |
| 3     | CMD_VAL_ERR   | Неправильное значение                 |
| 5     | CMD_ACK       | Подтверждение выполнения команды      |
